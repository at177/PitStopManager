<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pit Stop Strategy - Endurance Karting</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --race-red: #ff0033;
      --race-yellow: #ffcc00;
      --race-green: #00ff66;
      --dark-bg: #0a0a0a;
      --surface: #1a1a1a;
      --surface-elevated: #252525;
      --text-primary: #ffffff;
      --text-secondary: #999999;
      --border: #333333;
      --active-driver: #ff0033;
      --ready-driver: #ffcc00;
      --waiting-driver: #444444;
    }

    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--dark-bg);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    #root {
      min-height: 100vh;
      padding-bottom: 2rem;
    }

    .app-header {
      background: linear-gradient(135deg, var(--race-red) 0%, #cc0029 100%);
      padding: 1rem 1rem;
      text-align: center;
      box-shadow: 0 4px 20px rgba(255, 0, 51, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-title {
      font-family: 'Orbitron', monospace;
      font-size: 1.75rem;
      font-weight: 900;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .app-subtitle {
      font-size: 1.125rem;
      font-weight: 700;
      opacity: 0.95;
      margin-top: 0.25rem;
      letter-spacing: 1.5px;
    }

    .app-version {
      position: absolute;
      bottom: 0.5rem;
      right: 1rem;
      font-size: 0.625rem;
      color: rgba(255, 255, 255, 0.6);
      font-family: 'Rajdhani', sans-serif;
      letter-spacing: 0.5px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }

    .section {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border);
    }

    .section-title {
      font-family: 'Orbitron', monospace;
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--race-yellow);
    }

    .race-timer {
      background: var(--surface-elevated);
      padding: 1rem 1.5rem;
      border-radius: 12px;
      text-align: center;
      border: 2px solid var(--race-green);
      box-shadow: 0 0 20px rgba(0, 255, 102, 0.2);
      margin-bottom: 1.5rem;
    }

    .timer-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .timer-display {
      font-family: 'Orbitron', monospace;
      font-size: 3rem;
      font-weight: 900;
      color: var(--race-green);
      text-shadow: 0 0 10px rgba(0, 255, 102, 0.5);
      letter-spacing: 2px;
      font-variant-numeric: tabular-nums;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      background: rgba(0, 0, 0, 0.3);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      display: inline-block;
      border: 2px solid rgba(0, 255, 102, 0.2);
    }

    .timer-controls {
      margin-top: 1.5rem;
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-family: 'Rajdhani', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: var(--race-green);
      color: var(--dark-bg);
    }

    .btn-primary:hover {
      background: #00dd55;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 255, 102, 0.4);
    }

    .btn-danger {
      background: var(--race-red);
      color: white;
    }

    .btn-danger:hover {
      background: #cc0029;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 0, 51, 0.4);
    }

    .btn-secondary {
      background: var(--surface-elevated);
      color: white;
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #333;
      transform: translateY(-2px);
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: white;
      font-family: 'Rajdhani', sans-serif;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--race-yellow);
      box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.2);
    }

    .driver-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .driver-card {
      background: var(--surface-elevated);
      padding: 1rem;
      border-radius: 8px;
      border-left: 4px solid var(--waiting-driver);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .driver-card.active {
      border-left-color: var(--active-driver);
      background: linear-gradient(90deg, rgba(255, 0, 51, 0.15) 0%, var(--surface-elevated) 100%);
      box-shadow: 0 2px 12px rgba(255, 0, 51, 0.3);
    }

    .driver-card.next-up {
      border-left-color: var(--ready-driver);
      background: linear-gradient(90deg, rgba(255, 204, 0, 0.15) 0%, var(--surface-elevated) 100%);
    }

    .driver-info {
      flex: 1;
    }

    .driver-name {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .driver-status {
      font-size: 0.875rem;
      color: var(--text-secondary);
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .status-badge {
      background: var(--dark-bg);
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.active {
      background: var(--active-driver);
      color: white;
    }

    .status-badge.next {
      background: var(--ready-driver);
      color: var(--dark-bg);
    }

    .driver-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .add-driver-form {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .add-driver-form input {
      flex: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-card {
      background: var(--surface-elevated);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-family: 'Orbitron', monospace;
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--race-yellow);
      font-variant-numeric: tabular-nums;
      letter-spacing: 1px;
    }

    .next-pitstop {
      background: linear-gradient(135deg, rgba(255, 204, 0, 0.2) 0%, rgba(255, 204, 0, 0.05) 100%);
      padding: 1.5rem;
      border-radius: 8px;
      border: 2px solid var(--race-yellow);
      margin-top: 1rem;
      text-align: center;
    }

    .next-pitstop-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .next-pitstop-time {
      font-family: 'Orbitron', monospace;
      font-size: 2rem;
      font-weight: 700;
      color: var(--race-yellow);
    }

    .history-item {
      background: var(--surface-elevated);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 0.75rem;
      border-left: 3px solid var(--race-yellow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-time {
      font-family: 'Orbitron', monospace;
      color: var(--race-yellow);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: 1px;
    }

    .setup-complete {
      display: none;
    }

    .setup-active {
      display: block;
    }

    @media (max-width: 640px) {
      .app-header {
        padding: 0.75rem 1rem;
      }

      .app-title {
        font-size: 1.25rem;
      }

      .app-subtitle {
        font-size: 0.875rem;
        margin-top: 0.125rem;
      }

      .app-version {
        font-size: 0.5rem;
        bottom: 0.375rem;
        right: 0.75rem;
      }

      .container {
        padding: 0.75rem;
      }

      .section {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .timer-display {
        font-size: 2.5rem;
      }

      .timer-label {
        font-size: 0.75rem;
      }

      .section-title {
        font-size: 1.125rem;
        margin-bottom: 1rem;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }

      .stat-card {
        padding: 0.75rem;
      }

      .stat-label {
        font-size: 0.625rem;
      }

      .stat-value {
        font-size: 1.25rem;
      }

      .tabs {
        gap: 0.25rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 1rem;
      }

      .tab {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .driver-card {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .driver-name {
        font-size: 1rem;
      }

      .driver-status {
        font-size: 0.75rem;
        gap: 0.5rem;
      }

      .driver-actions {
        gap: 0.5rem;
      }

      .btn {
        font-size: 0.875rem;
        padding: 0.625rem 1rem;
      }

      .btn-small {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        font-size: 0.875rem;
        margin-bottom: 0.375rem;
      }

      .form-input {
        font-size: 1rem;
        padding: 0.75rem;
      }

      .history-item {
        padding: 0.75rem;
        font-size: 0.875rem;
      }

      .status-badge {
        font-size: 0.625rem;
        padding: 0.25rem 0.5rem;
      }

      /* Countdown overlay adjustments for mobile */
      .container > div:first-child[style*="position: fixed"] {
        padding: 2rem 2rem !important;
      }

      .container > div:first-child[style*="position: fixed"] > div:nth-child(2) {
        font-size: 5rem !important;
      }
    }

    .alert {
      background: var(--surface-elevated);
      border-left: 4px solid var(--race-yellow);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .alert-warning {
      border-left-color: var(--race-red);
      background: linear-gradient(90deg, rgba(255, 0, 51, 0.15) 0%, var(--surface-elevated) 100%);
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
    }

    .tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-family: 'Rajdhani', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .tab.active {
      color: var(--race-yellow);
      border-bottom-color: var(--race-yellow);
    }

    .tab:hover {
      color: white;
    }

    @keyframes pulse {
      0%, 100% {
        transform: translate(-50%, -50%) scale(1);
      }
      50% {
        transform: translate(-50%, -50%) scale(1.05);
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
      const [activeTab, setActiveTab] = useState('race');
      const [raceStarted, setRaceStarted] = useState(false);
      const [raceFinished, setRaceFinished] = useState(false);
      const [racePaused, setRacePaused] = useState(false);
      const [elapsedTime, setElapsedTime] = useState(0);
      const [raceStartTimestamp, setRaceStartTimestamp] = useState(0);
      const [pausedAtTime, setPausedAtTime] = useState(0);
      
      // Race configuration
      const [teamName, setTeamName] = useState('TVP Racing');
      const [trackName, setTrackName] = useState('');
      const [kartRange, setKartRange] = useState(60); // minutes
      const [minPitTime, setMinPitTime] = useState(0); // seconds
      const [pitExitTime, setPitExitTime] = useState(0); // seconds - time from pit bay to exit line
      const [raceDuration, setRaceDuration] = useState(480); // minutes (8 hours default)
      
      // Drivers
      const [drivers, setDrivers] = useState([
        { id: Date.now(), name: 'Harry', stints: 0, totalTime: 0 },
        { id: Date.now() + 1, name: 'Gary', stints: 0, totalTime: 0 }
      ]);
      const [newDriverName, setNewDriverName] = useState('');
      const [currentDriverIndex, setCurrentDriverIndex] = useState(0);
      const [stintStartTime, setStintStartTime] = useState(0);
      const [nextDriverReady, setNextDriverReady] = useState(false);
      
      // Pit stop management
      const [inPitStop, setInPitStop] = useState(false);
      const [pitStopStartTime, setPitStopStartTime] = useState(0);
      const [pitStopElapsedTime, setPitStopElapsedTime] = useState(0);
      const [sameDriverContinues, setSameDriverContinues] = useState(false);
      const [showExitCountdown, setShowExitCountdown] = useState(false);
      const [exitCountdownStart, setExitCountdownStart] = useState(0);
      
      // Pit stop history
      const [pitStops, setPitStops] = useState([]);
      
      // Driver alert tracking
      const [shown20MinAlert, setShown20MinAlert] = useState(false);
      const [shown10MinAlert, setShown10MinAlert] = useState(false);
      
      const timerRef = useRef(null);

      // Show driver alerts at 20 and 10 minutes before pit stop
      useEffect(() => {
        if (raceStarted && !inPitStop && drivers.length > 0) {
          const nextPitTime = stintStartTime + (kartRange * 60);
          const timeUntilPit = nextPitTime - elapsedTime;
          const minutesUntilPit = Math.floor(timeUntilPit / 60);
          
          const nextDriverIndex = (currentDriverIndex + 1) % drivers.length;
          const nextDriverName = drivers[nextDriverIndex]?.name;
          
          // 20 minute alert
          if (minutesUntilPit === 20 && !shown20MinAlert) {
            alert(`Tell ${nextDriverName} that they have 20 mins!`);
            setShown20MinAlert(true);
          }
          
          // 10 minute alert
          if (minutesUntilPit === 10 && !shown10MinAlert) {
            alert(`Tell ${nextDriverName} that they have 10 mins!`);
            setShown10MinAlert(true);
          }
        }
      }, [raceStarted, inPitStop, elapsedTime, stintStartTime, kartRange, drivers, currentDriverIndex, shown20MinAlert, shown10MinAlert]);

      // Hide exit countdown when time expires
      useEffect(() => {
        if (showExitCountdown && pitStopStartTime > 0) {
          const timeSincePitEntry = elapsedTime - pitStopStartTime;
          const timeRemaining = minPitTime - timeSincePitEntry;
          if (timeRemaining <= 0) {
            setShowExitCountdown(false);
          }
        }
      }, [showExitCountdown, pitStopStartTime, elapsedTime, minPitTime]);

      // Auto-save race state to localStorage
      useEffect(() => {
        if (raceStarted) {
          const raceState = {
            raceStarted,
            raceFinished,
            racePaused,
            elapsedTime,
            raceStartTimestamp,
            pausedAtTime,
            teamName,
            trackName,
            kartRange,
            minPitTime,
            pitExitTime,
            raceDuration,
            drivers,
            currentDriverIndex,
            stintStartTime,
            nextDriverReady,
            inPitStop,
            pitStopStartTime,
            pitStopElapsedTime,
            sameDriverContinues,
            pitStops,
            shown20MinAlert,
            shown10MinAlert,
            lastSaved: new Date().toISOString()
          };
          localStorage.setItem('kartraceState', JSON.stringify(raceState));
        }
      }, [raceStarted, raceFinished, racePaused, elapsedTime, raceStartTimestamp, pausedAtTime, 
          drivers, currentDriverIndex, stintStartTime, 
          nextDriverReady, inPitStop, pitStopStartTime, pitStopElapsedTime, pitStops, teamName, trackName, kartRange, 
          minPitTime, pitExitTime, raceDuration]);

      // Check for saved race on mount
      useEffect(() => {
        const savedState = localStorage.getItem('kartraceState');
        if (savedState && !raceStarted) {
          const state = JSON.parse(savedState);
          const timeSaved = new Date(state.lastSaved);
          const hoursAgo = (new Date() - timeSaved) / (1000 * 60 * 60);
          
          // Only prompt to restore if saved within last 48 hours
          if (hoursAgo < 48) {
            const restore = confirm(
              `Found a saved race from ${timeSaved.toLocaleString()}.\n` +
              `Track: ${state.trackName}\n` +
              `Race time: ${formatTime(state.elapsedTime)}\n\n` +
              `Restore this race?`
            );
            
            if (restore) {
              setRaceStarted(state.raceStarted);
              setRaceFinished(state.raceFinished || false);
              
              // Recalculate elapsed time from timestamp if race was running
              if (!state.racePaused && state.raceStartTimestamp) {
                const now = Date.now();
                const actualElapsed = Math.floor((now - state.raceStartTimestamp) / 1000);
                setElapsedTime(actualElapsed);
                setRaceStartTimestamp(state.raceStartTimestamp);
              } else {
                // Race was paused, use saved elapsed time
                setElapsedTime(state.elapsedTime);
                setRaceStartTimestamp(state.raceStartTimestamp || Date.now());
              }
              
              setRacePaused(state.racePaused);
              setPausedAtTime(state.pausedAtTime || state.elapsedTime);
              setTeamName(state.teamName || '');
              setTrackName(state.trackName);
              setKartRange(state.kartRange);
              setMinPitTime(state.minPitTime);
              setPitExitTime(state.pitExitTime);
              setRaceDuration(state.raceDuration);
              setDrivers(state.drivers);
              setCurrentDriverIndex(state.currentDriverIndex);
              setStintStartTime(state.stintStartTime);
              setNextDriverReady(state.nextDriverReady || false);
              setInPitStop(state.inPitStop || false);
              setPitStopStartTime(state.pitStopStartTime || 0);
              setPitStopElapsedTime(state.pitStopElapsedTime || 0);
              setSameDriverContinues(state.sameDriverContinues || false);
              setPitStops(state.pitStops);
              setShown20MinAlert(state.shown20MinAlert || false);
              setShown10MinAlert(state.shown10MinAlert || false);
              setActiveTab(state.raceFinished ? 'results' : 'race');
            } else {
              localStorage.removeItem('kartraceState');
            }
          } else {
            // Clean up old saves
            localStorage.removeItem('kartraceState');
          }
        }
      }, []);

      useEffect(() => {
        if (raceStarted) {
          timerRef.current = setInterval(() => {
            if (!racePaused) {
              // Calculate actual elapsed time from start timestamp
              const now = Date.now();
              const actualElapsed = Math.floor((now - raceStartTimestamp) / 1000);
              setElapsedTime(actualElapsed);
            }
            if (inPitStop) {
              setPitStopElapsedTime(prev => prev + 1);
            }
          }, 1000);
        } else {
          if (timerRef.current) {
            clearInterval(timerRef.current);
          }
        }
        return () => {
          if (timerRef.current) {
            clearInterval(timerRef.current);
          }
        };
      }, [raceStarted, racePaused, inPitStop, raceStartTimestamp]);

      const formatTime = (seconds) => {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      };

      const addDriver = () => {
        if (newDriverName.trim()) {
          setDrivers([...drivers, {
            id: Date.now(),
            name: newDriverName.trim(),
            stints: 0,
            totalTime: 0
          }]);
          setNewDriverName('');
        }
      };

      const removeDriver = (id) => {
        setDrivers(drivers.filter(d => d.id !== id));
      };

      const moveDriverUp = (index) => {
        if (index > 0) {
          const newDrivers = [...drivers];
          [newDrivers[index - 1], newDrivers[index]] = [newDrivers[index], newDrivers[index - 1]];
          setDrivers(newDrivers);
          
          // Adjust current driver index if affected
          if (currentDriverIndex === index) {
            setCurrentDriverIndex(index - 1);
          } else if (currentDriverIndex === index - 1) {
            setCurrentDriverIndex(index);
          }
        }
      };

      const moveDriverDown = (index) => {
        if (index < drivers.length - 1) {
          const newDrivers = [...drivers];
          [newDrivers[index], newDrivers[index + 1]] = [newDrivers[index + 1], newDrivers[index]];
          setDrivers(newDrivers);
          
          // Adjust current driver index if affected
          if (currentDriverIndex === index) {
            setCurrentDriverIndex(index + 1);
          } else if (currentDriverIndex === index + 1) {
            setCurrentDriverIndex(index);
          }
        }
      };

      const calculateNextStintTimes = () => {
        if (!raceStarted || drivers.length === 0) return [];
        
        const raceEndTime = raceDuration * 60; // Race end in seconds (raceDuration is in minutes)
        let simulatedTime = elapsedTime;
        let simulatedDriverIndex = currentDriverIndex;
        const stintTimes = drivers.map(() => []);
        
        // If currently in pit, next driver starts after pit completes
        if (inPitStop) {
          simulatedTime = elapsedTime + (minPitTime - pitStopElapsedTime) + pitExitTime;
          simulatedDriverIndex = window.emergencyTargetDriver || ((currentDriverIndex + 1) % drivers.length);
        } else {
          // Current driver continues until next pit
          const currentStintRemaining = (stintStartTime + (kartRange * 60)) - elapsedTime;
          simulatedTime += Math.max(0, currentStintRemaining) + minPitTime + pitExitTime;
          simulatedDriverIndex = (currentDriverIndex + 1) % drivers.length;
        }
        
        // Calculate stints until race end
        while (simulatedTime < raceEndTime) {
          const stintDuration = kartRange * 60;
          const stintEndTime = simulatedTime + stintDuration;
          
          // Don't add stint if it would start after race ends
          if (simulatedTime >= raceEndTime) break;
          
          stintTimes[simulatedDriverIndex].push({
            startTime: simulatedTime,
            endTime: Math.min(stintEndTime, raceEndTime) // Cap at race end
          });
          
          simulatedTime += stintDuration + minPitTime + pitExitTime;
          
          // Move to next driver in rotation
          simulatedDriverIndex = (simulatedDriverIndex + 1) % drivers.length;
        }
        
        return stintTimes;
      };

      const startRace = () => {
        if (drivers.length === 0) {
          alert('Please add at least one driver!');
          return;
        }
        if (!trackName.trim()) {
          alert('Please enter a track name!');
          return;
        }
        const now = Date.now();
        setRaceStarted(true);
        setRaceStartTimestamp(now);
        setStintStartTime(0);
        setActiveTab('race');
        
        // Reset driver alerts
        setShown20MinAlert(false);
        setShown10MinAlert(false);
      };

      const togglePause = () => {
        if (!racePaused) {
          // Pausing - record current elapsed time
          setPausedAtTime(elapsedTime);
        } else {
          // Resuming - adjust start timestamp to account for pause duration
          const pauseDuration = elapsedTime - pausedAtTime;
          setRaceStartTimestamp(Date.now() - (elapsedTime * 1000));
        }
        setRacePaused(!racePaused);
      };

      const resetRace = () => {
        if (confirm('Are you sure you want to reset the race?')) {
          setRaceStarted(false);
          setRaceFinished(false);
          setRacePaused(false);
          setElapsedTime(0);
          setRaceStartTimestamp(0);
          setPausedAtTime(0);
          setCurrentDriverIndex(0);
          setStintStartTime(0);
          setPitStops([]);
          setDrivers(drivers.map(d => ({ ...d, stints: 0, totalTime: 0 })));
          setActiveTab('race');
          setInPitStop(false);
          setPitStopStartTime(0);
          setPitStopElapsedTime(0);
          setSameDriverContinues(false);
          // Clear saved state
          localStorage.removeItem('kartraceState');
        }
      };

      const finishRace = () => {
        if (confirm('End the race and show final results?')) {
          // Record final stint for current driver
          const finalStintTime = elapsedTime - stintStartTime;
          const currentDriver = drivers[currentDriverIndex];
          
          const updatedDrivers = [...drivers];
          updatedDrivers[currentDriverIndex] = {
            ...currentDriver,
            totalTime: currentDriver.totalTime + finalStintTime
          };
          setDrivers(updatedDrivers);
          
          setRaceFinished(true);
          setRacePaused(true); // Stop the timer
          setActiveTab('results');
        }
      };

      const executePitStop = () => {
        // Enter pit bay - start the minimum pit time countdown
        setInPitStop(true);
        setPitStopStartTime(elapsedTime);
        setPitStopElapsedTime(0); // Reset pit stop timer
        // Race timer continues running
      };

      const cancelPitStop = () => {
        if (confirm('Cancel pit stop and return to previous state?')) {
          // Return to pre-pit stop state
          setInPitStop(false);
          setPitStopElapsedTime(0);
          setSameDriverContinues(false);
          // Don't change driver index or stint start time - keep racing as before
        }
      };

      const completePitStop = () => {
        const currentStintTime = pitStopStartTime - stintStartTime;
        const currentDriver = drivers[currentDriverIndex];
        const actualPitTime = elapsedTime - pitStopStartTime;
        // Add exit travel time to get total time in pits
        const totalPitTime = actualPitTime + pitExitTime;
        
        // Record pit stop (mark as double stint if same driver continues)
        setPitStops([{
          time: pitStopStartTime,
          driver: currentDriver.name,
          stintDuration: currentStintTime,
          pitDuration: totalPitTime,
          timestamp: new Date().toLocaleTimeString(),
          doubleStint: sameDriverContinues
        }, ...pitStops]);

        // Update driver stats
        const updatedDrivers = [...drivers];
        updatedDrivers[currentDriverIndex] = {
          ...currentDriver,
          stints: currentDriver.stints + 1,
          totalTime: currentDriver.totalTime + currentStintTime
        };
        setDrivers(updatedDrivers);

        // Move to next driver in rotation (or stay with same driver)
        const nextIndex = sameDriverContinues ? currentDriverIndex : (currentDriverIndex + 1) % drivers.length;
        
        setCurrentDriverIndex(nextIndex);
        // Stint starts NOW when driver is released (not after exit time)
        setStintStartTime(elapsedTime);
        
        // Start exit countdown overlay
        setShowExitCountdown(true);
        setExitCountdownStart(elapsedTime);
        
        // Exit pit stop mode and reset states
        setInPitStop(false);
        setPitStopElapsedTime(0);
        setNextDriverReady(false);
        setSameDriverContinues(false);
        
        // Reset driver alerts for next stint
        setShown20MinAlert(false);
        setShown10MinAlert(false);
      };

      const emergencyDriverChange = (newDriverIndex) => {
        const isDoublStint = newDriverIndex === currentDriverIndex;
        const driverName = drivers[newDriverIndex]?.name;
        const confirmMessage = isDoublStint 
          ? `${driverName} will do a double stint. Continue?`
          : `Change to ${driverName}?`;
        
        if (confirm(confirmMessage)) {
          // Enter pit bay for driver change
          setInPitStop(true);
          setPitStopStartTime(elapsedTime);
          setPitStopElapsedTime(0); // Reset pit timer
          // Race timer continues running
          // Store the target driver index for after pit completes
          window.emergencyTargetDriver = newDriverIndex;
          window.isDoubleStint = isDoublStint;
        }
      };

      const completeEmergencyPit = () => {
        const currentStintTime = pitStopStartTime - stintStartTime;
        const currentDriver = drivers[currentDriverIndex];
        const actualPitTime = elapsedTime - pitStopStartTime;
        // Add exit travel time to get total time in pits
        const totalPitTime = actualPitTime + pitExitTime;
        const isDoubleStint = window.isDoubleStint || false;
        
        setPitStops([{
          time: pitStopStartTime,
          driver: currentDriver.name,
          stintDuration: currentStintTime,
          pitDuration: totalPitTime,
          timestamp: new Date().toLocaleTimeString(),
          emergency: !isDoubleStint,
          doubleStint: isDoubleStint
        }, ...pitStops]);

        const updatedDrivers = [...drivers];
        updatedDrivers[currentDriverIndex] = {
          ...currentDriver,
          stints: currentDriver.stints + 1,
          totalTime: currentDriver.totalTime + currentStintTime
        };
        setDrivers(updatedDrivers);

        setCurrentDriverIndex(window.emergencyTargetDriver);
        // Stint starts NOW when driver is released
        setStintStartTime(elapsedTime);
        
        // Start exit countdown overlay
        setShowExitCountdown(true);
        setExitCountdownStart(elapsedTime);
        
        setInPitStop(false);
        setPitStopElapsedTime(0);
        setNextDriverReady(false);
        setSameDriverContinues(false);
        delete window.emergencyTargetDriver;
        delete window.isDoubleStint;
        
        // Reset driver alerts for next stint
        setShown20MinAlert(false);
        setShown10MinAlert(false);
      };

      const currentStintTime = elapsedTime - stintStartTime;
      const nextPitStopTime = stintStartTime + (kartRange * 60);
      const timeUntilPit = nextPitStopTime - elapsedTime;
      const nextDriverIndex = (currentDriverIndex + 1) % drivers.length;

      // Pit stop timer calculations
      const timeUntilCanExit = inPitStop ? Math.max(0, minPitTime - pitExitTime - pitStopElapsedTime) : 0;
      const canExit = inPitStop && pitStopElapsedTime >= (minPitTime - pitExitTime);
      const isEmergency = inPitStop && window.emergencyTargetDriver !== undefined;

      return (
        <div>
          <div className="app-header" style={{position: 'relative'}}>
            <div className="app-title">Pit Stop Manager</div>
            {teamName && <div className="app-subtitle">{teamName}</div>}
            <div className="app-version">v1.0</div>
          </div>

          {/* Floating Exit Countdown Overlay */}
          {showExitCountdown && minPitTime > 0 && (() => {
            // Time remaining = Min Pit Time - (time since crossing pit entry line)
            const timeSincePitEntry = elapsedTime - pitStopStartTime;
            const timeRemaining = Math.max(0, minPitTime - timeSincePitEntry);
            return (
              <div style={{
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                zIndex: 9999,
                background: timeRemaining > 0 ? 'linear-gradient(135deg, #ff0033 0%, #cc0029 100%)' : 'linear-gradient(135deg, #00ff66 0%, #00cc52 100%)',
                padding: window.innerWidth < 640 ? '2rem 2rem' : '3rem 4rem',
                borderRadius: '24px',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.8)',
                border: '4px solid ' + (timeRemaining > 0 ? 'var(--race-red)' : 'var(--race-green)'),
                textAlign: 'center',
                animation: timeRemaining <= 3 && timeRemaining > 0 ? 'pulse 0.5s infinite' : 'none',
                maxWidth: '90vw'
              }}>
                <div style={{
                  fontSize: window.innerWidth < 640 ? '0.875rem' : '1rem',
                  fontWeight: '700',
                  color: 'white',
                  marginBottom: '1rem',
                  textTransform: 'uppercase',
                  letterSpacing: window.innerWidth < 640 ? '2px' : '3px'
                }}>
                  {timeRemaining > 0 ? 'PIT EXIT COUNTDOWN' : 'CLEAR TO CROSS'}
                </div>
                <div style={{
                  fontFamily: 'Orbitron, monospace',
                  fontSize: window.innerWidth < 640 ? '5rem' : '8rem',
                  fontWeight: '900',
                  color: 'white',
                  lineHeight: '1',
                  textShadow: '0 4px 20px rgba(0, 0, 0, 0.5)'
                }}>
                  {timeRemaining}
                </div>
                <div style={{
                  fontSize: window.innerWidth < 640 ? '0.75rem' : '0.875rem',
                  color: 'rgba(255, 255, 255, 0.9)',
                  marginTop: '1rem',
                  textTransform: 'uppercase',
                  letterSpacing: window.innerWidth < 640 ? '1px' : '2px'
                }}>
                  {timeRemaining > 0 ? 'DO NOT CROSS PIT EXIT LINE' : 'SAFE TO CROSS'}
                </div>
              </div>
            );
          })()}

          <div className="container">
            {!raceStarted ? (
              <div className="section">
                <div className="section-title">Race Setup</div>
                
                <div className="form-group">
                  <label className="form-label">Team Name</label>
                  <input 
                    type="text" 
                    className="form-input" 
                    value={teamName}
                    onChange={(e) => setTeamName(e.target.value)}
                    placeholder="e.g., Racing Legends"
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">Track Name</label>
                  <input 
                    type="text" 
                    className="form-input" 
                    value={trackName}
                    onChange={(e) => setTrackName(e.target.value)}
                    placeholder="e.g., Silverstone GP"
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">Kart Range (minutes)</label>
                  <input 
                    type="number" 
                    className="form-input" 
                    value={kartRange}
                    onChange={(e) => setKartRange(Number(e.target.value))}
                    min="20"
                    max="120"
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">Minimum Pit Stop Time (seconds)</label>
                  <input 
                    type="number" 
                    className="form-input" 
                    value={minPitTime}
                    onChange={(e) => {
                      const newMinPitTime = Number(e.target.value);
                      setMinPitTime(newMinPitTime);
                      // If min pit time is 0, also set pit exit time to 0
                      if (newMinPitTime === 0) {
                        setPitExitTime(0);
                      }
                    }}
                    min="0"
                    max="300"
                  />
                  <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.5rem'}}>
                    Set to 0 if no minimum pit time
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Pit Exit Time (seconds)</label>
                  <input 
                    type="number" 
                    className="form-input" 
                    value={pitExitTime}
                    onChange={(e) => setPitExitTime(Number(e.target.value))}
                    min="0"
                    max="60"
                    disabled={minPitTime === 0}
                  />
                  <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.5rem'}}>
                    {minPitTime === 0 ? 'Disabled when no minimum pit time' : 'Time from pit bay to exit line'}
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Race Duration (minutes)</label>
                  <input 
                    type="number" 
                    className="form-input" 
                    value={raceDuration}
                    onChange={(e) => setRaceDuration(Number(e.target.value))}
                    min="60"
                    max="1440"
                    step="5"
                  />
                  <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.5rem'}}>
                    {Math.floor(raceDuration / 60)}h {raceDuration % 60}m
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Driver Order</label>
                  <div className="driver-list">
                    {drivers.map((driver, index) => (
                      <div key={driver.id} className="driver-card">
                        <div className="driver-info">
                          <div className="driver-name">{index + 1}. {driver.name}</div>
                        </div>
                        <div className="driver-actions">
                          {index > 0 && (
                            <button className="btn btn-secondary btn-small" onClick={() => moveDriverUp(index)}>‚Üë</button>
                          )}
                          {index < drivers.length - 1 && (
                            <button className="btn btn-secondary btn-small" onClick={() => moveDriverDown(index)}>‚Üì</button>
                          )}
                          <button className="btn btn-danger btn-small" onClick={() => removeDriver(driver.id)}>Remove</button>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="add-driver-form">
                    <input 
                      type="text" 
                      className="form-input" 
                      value={newDriverName}
                      onChange={(e) => setNewDriverName(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addDriver()}
                      placeholder="Driver name"
                    />
                    <button className="btn btn-primary" onClick={addDriver}>Add</button>
                  </div>
                </div>

                <button className="btn btn-primary" style={{width: '100%', marginTop: '1rem', padding: '1rem'}} onClick={startRace}>
                  Start Race
                </button>
              </div>
            ) : (
              <>
                <div className="race-timer">
                  <div className="timer-label">Race Time</div>
                  <div className="timer-display">{formatTime(elapsedTime)}</div>
                  <div style={{
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center',
                    gap: '1.5rem',
                    marginTop: '0.75rem',
                    fontSize: '0.875rem',
                    color: 'var(--text-secondary)'
                  }}>
                    <div>
                      <span style={{color: 'var(--text-secondary)'}}>Start: </span>
                      <span style={{color: 'white', fontWeight: '600'}}>
                        {new Date(raceStartTimestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
                      </span>
                    </div>
                    <div>
                      <span style={{color: 'var(--text-secondary)'}}>End: </span>
                      <span style={{color: 'white', fontWeight: '600'}}>
                        {new Date(raceStartTimestamp + raceDuration * 60 * 1000).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
                      </span>
                    </div>
                  </div>
                  <div style={{
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center',
                    gap: '1.5rem',
                    marginTop: '0.75rem',
                    fontSize: '0.875rem',
                    color: 'var(--text-secondary)'
                  }}>
                    <div style={{
                      background: 'var(--surface-elevated)',
                      padding: '0.5rem 1rem',
                      borderRadius: '6px',
                      border: '1px solid var(--border)'
                    }}>
                      <span style={{color: 'var(--race-yellow)', fontWeight: '700', fontSize: '1.25rem'}}>
                        {pitStops.length}
                      </span>
                      <span style={{marginLeft: '0.5rem'}}>Pit Stops</span>
                    </div>
                    <div>‚úì Auto-saving</div>
                  </div>
                </div>

                <div className="tabs">
                  {!raceFinished ? (
                    <>
                      <button className={`tab ${activeTab === 'race' ? 'active' : ''}`} onClick={() => setActiveTab('race')}>
                        Race
                      </button>
                      <button className={`tab ${activeTab === 'drivers' ? 'active' : ''}`} onClick={() => setActiveTab('drivers')}>
                        Drivers
                      </button>
                      <button className={`tab ${activeTab === 'history' ? 'active' : ''}`} onClick={() => setActiveTab('history')}>
                        Logs
                      </button>
                      <button className={`tab ${activeTab === 'settings' ? 'active' : ''}`} onClick={() => setActiveTab('settings')}>
                        Settings
                      </button>
                    </>
                  ) : (
                    <button className={`tab active`}>
                      üèÅ Final Results
                    </button>
                  )}
                </div>

                {activeTab === 'race' && !raceFinished && (
                  <>
                    {inPitStop && (
                      <div className="section" style={{
                        background: 'linear-gradient(135deg, rgba(255, 204, 0, 0.2) 0%, var(--surface) 100%)',
                        border: '2px solid var(--race-yellow)',
                        boxShadow: '0 0 30px rgba(255, 204, 0, 0.3)'
                      }}>
                        <div className="section-title" style={{color: 'var(--race-yellow)', textAlign: 'center', marginBottom: '1.5rem'}}>
                          üèÅ IN PITS üèÅ
                        </div>
                        
                        <div style={{
                          background: 'var(--dark-bg)',
                          padding: '2rem',
                          borderRadius: '12px',
                          textAlign: 'center',
                          marginBottom: '1.5rem'
                        }}>
                          <div className="timer-label">Pit Stop Timer</div>
                          <div className="timer-display" style={{
                            color: canExit ? 'var(--race-green)' : 'var(--race-red)',
                            textShadow: canExit ? '0 0 10px rgba(0, 255, 102, 0.5)' : '0 0 10px rgba(255, 0, 51, 0.5)'
                          }}>
                            {formatTime(pitStopElapsedTime)}
                          </div>
                        </div>

                        {minPitTime > 0 && (
                          <div className="stats-grid" style={{marginBottom: '1.5rem'}}>
                            <div className="stat-card">
                              <div className="stat-label">Min Pit Time</div>
                              <div className="stat-value" style={{fontSize: '1.25rem'}}>{minPitTime}s</div>
                            </div>
                            <div className="stat-card">
                              <div className="stat-label">Exit Travel Time</div>
                              <div className="stat-value" style={{fontSize: '1.25rem'}}>{pitExitTime}s</div>
                            </div>
                            <div className="stat-card" style={{gridColumn: 'span 2'}}>
                              <div className="stat-label">Leave Pit Bay At</div>
                              <div className="stat-value" style={{fontSize: '1.25rem'}}>{minPitTime - pitExitTime}s</div>
                            </div>
                          </div>
                        )}

                        {!canExit && minPitTime > 0 && (
                          <div className="alert alert-warning" style={{marginBottom: '1.5rem'}}>
                            <strong>WAIT!</strong> You can leave the pit bay in {timeUntilCanExit} seconds
                          </div>
                        )}

                        {canExit && minPitTime > 0 && (
                          <div className="alert" style={{
                            borderLeftColor: 'var(--race-green)',
                            background: 'linear-gradient(90deg, rgba(0, 255, 102, 0.15) 0%, var(--surface-elevated) 100%)',
                            marginBottom: '1.5rem'
                          }}>
                            <strong>‚úì CLEAR TO EXIT</strong> - You can leave the pit bay now
                          </div>
                        )}

                        <div style={{
                          padding: '1rem',
                          background: 'var(--surface-elevated)',
                          borderRadius: '8px',
                          border: '1px solid var(--border)',
                          marginBottom: '1.5rem'
                        }}>
                          <label style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.75rem',
                            cursor: 'pointer',
                            userSelect: 'none'
                          }}>
                            <input 
                              type="checkbox" 
                              checked={sameDriverContinues}
                              onChange={(e) => setSameDriverContinues(e.target.checked)}
                              style={{
                                width: '20px',
                                height: '20px',
                                cursor: 'pointer',
                                accentColor: 'var(--race-yellow)'
                              }}
                            />
                            <span style={{fontSize: '1rem', fontWeight: '600'}}>
                              Same driver doing next stint
                            </span>
                          </label>
                          {sameDriverContinues && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.875rem',
                              color: 'var(--race-yellow)'
                            }}>
                              {drivers[currentDriverIndex]?.name} will continue for another stint
                            </div>
                          )}
                        </div>

                        <div style={{display: 'flex', gap: '0.75rem'}}>
                          <button 
                            className="btn btn-primary" 
                            style={{flex: 1, padding: '1rem', opacity: canExit ? 1 : 0.5}}
                            onClick={isEmergency ? completeEmergencyPit : completePitStop}
                            disabled={!canExit}
                          >
                            {canExit ? (minPitTime === 0 ? 'Click when driver exits pit' : 'Click when driver is released') : `Release in ${timeUntilCanExit}s`}
                          </button>
                          <button 
                            className="btn btn-danger" 
                            style={{padding: '1rem'}}
                            onClick={cancelPitStop}
                          >
                            Abort
                          </button>
                        </div>

                        {isEmergency && (
                          <div style={{
                            marginTop: '1rem',
                            padding: '1rem',
                            background: window.isDoubleStint ? 'rgba(255, 204, 0, 0.1)' : 'rgba(255, 0, 51, 0.1)',
                            borderRadius: '6px',
                            textAlign: 'center',
                            color: window.isDoubleStint ? 'var(--race-yellow)' : 'var(--race-red)',
                            fontWeight: '700'
                          }}>
                            {window.isDoubleStint ? '‚Üª DOUBLE STINT ‚Üª' : '‚ö† EMERGENCY DRIVER CHANGE ‚ö†'}<br/>
                            Next: {drivers[window.emergencyTargetDriver]?.name}
                          </div>
                        )}
                      </div>
                    )}

                    {!inPitStop && (
                      <>
                    <div className="section">
                      <div className="section-title">Current Stint</div>
                      
                      <div className="driver-card active">
                        <div className="driver-info">
                          <div className="driver-name">{drivers[currentDriverIndex]?.name}</div>
                          <div className="driver-status">
                            <span className="status-badge active">On Track</span>
                          </div>
                        </div>
                      </div>

                      <div className="stats-grid">
                        <div className="stat-card">
                          <div className="stat-label">Current Stint</div>
                          <div className="stat-value">{formatTime(currentStintTime)}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Time to Pit</div>
                          <div className="stat-value" style={{color: timeUntilPit < 300 ? 'var(--race-red)' : 'var(--race-yellow)'}}>
                            {timeUntilPit > 0 ? formatTime(timeUntilPit) : 'OVERDUE'}
                          </div>
                        </div>
                      </div>

                      {timeUntilPit < 300 && timeUntilPit > 0 && !nextDriverReady && (
                        <div className="alert alert-warning" style={{marginTop: '1rem'}}>
                          <strong>Warning:</strong> Pit stop due in {Math.floor(timeUntilPit / 60)} minutes - get {drivers[nextDriverIndex]?.name} ready!
                        </div>
                      )}
                    </div>

                    <div className="section">
                      <div className="section-title">Next Up</div>
                      <div className={`driver-card ${nextDriverReady ? 'next-up' : ''}`}>
                        <div className="driver-info">
                          <div className="driver-name">{drivers[nextDriverIndex]?.name}</div>
                          <div className="driver-status">
                            {nextDriverReady ? (
                              <span className="status-badge next">‚úì Ready</span>
                            ) : (
                              <span className="status-badge" style={{background: 'var(--waiting-driver)'}}>Waiting</span>
                            )}
                          </div>
                        </div>
                      </div>

                      {!nextDriverReady && (
                        <button 
                          className="btn btn-primary" 
                          style={{width: '100%', marginTop: '1rem', padding: '1rem'}}
                          onClick={() => {
                            if (confirm(`Confirm ${drivers[nextDriverIndex]?.name} is ready to enter the kart?`)) {
                              setNextDriverReady(true);
                            }
                          }}
                        >
                          Click when {drivers[nextDriverIndex]?.name} is ready
                        </button>
                      )}

                      {nextDriverReady && (
                        <button 
                          className="btn btn-danger" 
                          style={{
                            width: '100%', 
                            marginTop: '1rem', 
                            padding: '1rem'
                          }}
                          onClick={executePitStop}
                        >
                          Click when driver crosses pit entry line
                        </button>
                      )}
                    </div>
                    </>
                    )}
                  </>
                )}

                {activeTab === 'drivers' && !raceFinished && (
                  <div className="section">
                    <div className="section-title">Driver Statistics</div>
                    
                    <div style={{
                      padding: '1rem',
                      background: 'var(--surface-elevated)',
                      borderRadius: '8px',
                      border: '1px solid var(--border)',
                      marginBottom: '1.5rem',
                      fontSize: '0.875rem',
                      color: 'var(--text-secondary)'
                    }}>
                      üí° Use ‚Üë‚Üì buttons to change driver order. Predicted stints shown below each driver.
                    </div>

                    {(() => {
                      const predictedTimes = calculateNextStintTimes();
                      return drivers.map((driver, index) => {
                        const nextStints = predictedTimes[index] || [];
                        
                        return (
                          <div 
                            key={driver.id} 
                            className={`driver-card ${index === currentDriverIndex ? 'active' : index === (currentDriverIndex + 1) % drivers.length ? 'next-up' : ''}`}
                            style={{marginBottom: '1rem'}}
                          >
                            <div className="driver-info" style={{flex: 1}}>
                              <div style={{marginBottom: '0.5rem'}}>
                                <div className="driver-name">
                                  {index + 1}. {driver.name}
                                </div>
                              </div>
                              <div className="driver-status">
                                {index === currentDriverIndex && <span className="status-badge active">On Track</span>}
                                {index === (currentDriverIndex + 1) % drivers.length && <span className="status-badge next">Next Up</span>}
                                <span>Stints: {driver.stints}</span>
                                <span>Total: {formatTime(driver.totalTime)}</span>
                              </div>
                              {raceStarted && nextStints.length > 0 && (
                                <div style={{
                                  marginTop: '0.75rem',
                                  padding: '0.75rem',
                                  background: 'var(--dark-bg)',
                                  borderRadius: '4px',
                                  fontSize: '0.75rem'
                                }}>
                                  <div style={{color: 'var(--race-green)', fontWeight: '700', marginBottom: '0.5rem'}}>
                                    Predicted Stints:
                                  </div>
                                  {nextStints.map((stint, idx) => {
                                    // Stint number = completed stints + current stint (if on track) + predicted stint number
                                    const stintNumber = driver.stints + (index === currentDriverIndex ? 1 : 0) + idx + 1;
                                    return (
                                      <div key={idx} style={{color: 'var(--text-secondary)', marginBottom: '0.25rem'}}>
                                        #{stintNumber}: {new Date(raceStartTimestamp + stint.startTime * 1000).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})} - {new Date(raceStartTimestamp + stint.endTime * 1000).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </div>
                            <div className="driver-actions">
                              {index > 0 && index !== currentDriverIndex && (
                                <button className="btn btn-secondary btn-small" onClick={() => moveDriverUp(index)}>‚Üë</button>
                              )}
                              {index < drivers.length - 1 && index !== currentDriverIndex && (
                                <button className="btn btn-secondary btn-small" onClick={() => moveDriverDown(index)}>‚Üì</button>
                              )}
                            </div>
                          </div>
                        );
                      });
                    })()}
                  </div>
                )}

                {activeTab === 'history' && !raceFinished && (
                  <div className="section">
                    <div className="section-header">
                      <div className="section-title">Pit Stop History</div>
                      <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)'}}>
                        Total: {pitStops.length}
                      </div>
                    </div>

                    <div style={{
                      background: 'var(--surface-elevated)',
                      padding: '1rem',
                      borderRadius: '8px',
                      border: '1px solid var(--border)',
                      marginBottom: '1.5rem',
                      textAlign: 'center'
                    }}>
                      <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '0.5rem', textTransform: 'uppercase', letterSpacing: '1px'}}>
                        Total Time in Pits
                      </div>
                      <div style={{
                        fontFamily: 'Orbitron, monospace',
                        fontSize: '1.5rem',
                        fontWeight: '700',
                        color: 'var(--race-red)',
                        fontVariantNumeric: 'tabular-nums',
                        letterSpacing: '1px'
                      }}>
                        {formatTime(pitStops.reduce((total, stop) => total + (stop.pitDuration || 0), 0))}
                      </div>
                    </div>

                    <div style={{
                      fontSize: '0.875rem',
                      color: 'var(--text-secondary)',
                      marginBottom: '0.75rem',
                      textTransform: 'uppercase',
                      letterSpacing: '1px'
                    }}>
                      Pit Stop Log
                    </div>

                    {pitStops.length === 0 ? (
                      <div style={{textAlign: 'center', color: 'var(--text-secondary)', padding: '2rem'}}>
                        No pit stops yet
                      </div>
                    ) : (
                      pitStops.map((stop, index) => (
                        <div key={index} className="history-item">
                          <div>
                            <div style={{fontWeight: '700', fontSize: '1.125rem'}}>{stop.driver}</div>
                            <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)', marginTop: '0.25rem'}}>
                              Stint: {formatTime(stop.stintDuration)} | Pit: {formatTime(stop.pitDuration || 0)}
                              {stop.emergency && <span style={{color: 'var(--race-red)', marginLeft: '0.5rem', fontWeight: '700'}}>‚ö† EMERGENCY</span>}
                            </div>
                          </div>
                          <div style={{textAlign: 'right'}}>
                            <div className="history-time">{formatTime(stop.time)}</div>
                            <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.25rem'}}>{stop.timestamp}</div>
                          </div>
                        </div>
                      ))
                    )}

                    {drivers.length > 0 && (
                      <div style={{marginTop: '1.5rem', paddingTop: '1.5rem', borderTop: '1px solid var(--border)'}}>
                        <div style={{
                          fontSize: '0.875rem',
                          color: 'var(--text-secondary)',
                          marginBottom: '0.75rem',
                          textTransform: 'uppercase',
                          letterSpacing: '1px'
                        }}>
                          Driver Totals
                        </div>
                        <div className="driver-list">
                          {drivers.map((driver, index) => (
                            <div key={driver.id} className="driver-card">
                              <div className="driver-info">
                                <div className="driver-name">{driver.name}</div>
                                <div className="driver-status">
                                  <span>Stints: {driver.stints}</span>
                                  <span>Total Time: {formatTime(driver.totalTime)}</span>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'results' && raceFinished && (
                  <>
                    <div style={{
                      background: 'linear-gradient(135deg, var(--race-yellow) 0%, #d4a800 100%)',
                      padding: '2rem 1rem',
                      borderRadius: '12px',
                      textAlign: 'center',
                      marginBottom: '1.5rem',
                      boxShadow: '0 4px 20px rgba(255, 204, 0, 0.4)'
                    }}>
                      <div style={{fontSize: '3rem', marginBottom: '0.5rem'}}>üèÅ</div>
                      <div style={{
                        fontFamily: 'Orbitron, monospace',
                        fontSize: '1.5rem',
                        fontWeight: '900',
                        color: 'var(--dark-bg)',
                        textTransform: 'uppercase',
                        letterSpacing: '2px'
                      }}>
                        Race Complete
                      </div>
                      {teamName && (
                        <div style={{
                          fontSize: '1.125rem',
                          fontWeight: '700',
                          color: 'var(--dark-bg)',
                          marginTop: '0.5rem'
                        }}>
                          {teamName}
                        </div>
                      )}
                    </div>

                    <div className="section">
                      <div className="section-title">Race Summary</div>
                      
                      <div className="stats-grid" style={{gridTemplateColumns: '1fr 1fr', marginBottom: '1.5rem'}}>
                        <div className="stat-card">
                          <div className="stat-label">Total Race Time</div>
                          <div className="stat-value">{formatTime(elapsedTime)}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Total Pit Stops</div>
                          <div className="stat-value">{pitStops.length}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Time in Pits</div>
                          <div className="stat-value" style={{color: 'var(--race-red)'}}>
                            {formatTime(pitStops.reduce((total, stop) => total + (stop.pitDuration || 0), 0))}
                          </div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Track</div>
                          <div className="stat-value" style={{fontSize: '1rem'}}>{trackName}</div>
                        </div>
                      </div>

                      <div style={{
                        padding: '1rem',
                        background: 'var(--surface-elevated)',
                        borderRadius: '8px',
                        border: '1px solid var(--border)',
                        fontSize: '0.875rem',
                        color: 'var(--text-secondary)'
                      }}>
                        <div style={{display: 'grid', gap: '0.5rem'}}>
                          <div style={{display: 'flex', justifyContent: 'space-between'}}>
                            <span>Kart Range:</span>
                            <span style={{color: 'white'}}>{kartRange} minutes</span>
                          </div>
                          <div style={{display: 'flex', justifyContent: 'space-between'}}>
                            <span>Min Pit Time:</span>
                            <span style={{color: 'white'}}>{minPitTime} seconds</span>
                          </div>
                          <div style={{display: 'flex', justifyContent: 'space-between'}}>
                            <span>Pit Exit Time:</span>
                            <span style={{color: 'white'}}>{pitExitTime} seconds</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className="section">
                      <div className="section-title">Driver Performance</div>
                      <div className="driver-list">
                        {[...drivers].sort((a, b) => b.totalTime - a.totalTime).map((driver, index) => (
                          <div key={driver.id} className="driver-card" style={{
                            borderLeft: index === 0 ? '4px solid var(--race-yellow)' : '4px solid var(--waiting-driver)'
                          }}>
                            <div style={{
                              fontSize: '1.5rem',
                              fontWeight: '700',
                              color: 'var(--text-secondary)',
                              marginRight: '1rem'
                            }}>
                              #{index + 1}
                            </div>
                            <div className="driver-info" style={{flex: 1}}>
                              <div className="driver-name">{driver.name}</div>
                              <div className="driver-status">
                                <span>Stints: {driver.stints}</span>
                                <span>Total Time: {formatTime(driver.totalTime)}</span>
                                <span>Avg Stint: {driver.stints > 0 ? formatTime(Math.floor(driver.totalTime / driver.stints)) : '‚Äî'}</span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div className="section">
                      <div className="section-title">Pit Stop Log</div>
                      {pitStops.length === 0 ? (
                        <div style={{textAlign: 'center', color: 'var(--text-secondary)', padding: '2rem'}}>
                          No pit stops recorded
                        </div>
                      ) : (
                        pitStops.map((stop, index) => (
                          <div key={index} className="history-item">
                            <div>
                              <div style={{fontWeight: '700', fontSize: '1.125rem'}}>{stop.driver}</div>
                              <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)', marginTop: '0.25rem'}}>
                                Stint: {formatTime(stop.stintDuration)} | Pit: {formatTime(stop.pitDuration || 0)}
                                {stop.emergency && <span style={{color: 'var(--race-red)', marginLeft: '0.5rem', fontWeight: '700'}}>‚ö† EMERGENCY</span>}
                                {stop.doubleStint && <span style={{color: 'var(--race-yellow)', marginLeft: '0.5rem', fontWeight: '700'}}>‚Üª DOUBLE STINT</span>}
                              </div>
                            </div>
                            <div style={{textAlign: 'right'}}>
                              <div className="history-time">{formatTime(stop.time)}</div>
                              <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.25rem'}}>{stop.timestamp}</div>
                            </div>
                          </div>
                        ))
                      )}
                    </div>

                    <div className="section">
                      <button className="btn btn-danger" onClick={resetRace} style={{width: '100%', padding: '1rem'}}>
                        üîÑ Start New Race
                      </button>
                      <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', textAlign: 'center', marginTop: '0.75rem'}}>
                        üí° Tip: Screenshot this page to save your race results
                      </div>
                    </div>
                  </>
                )}

                {activeTab === 'settings' && !raceFinished && (
                  <>
                    <div className="section">
                      <div className="section-title">Race Controls</div>

                      <div style={{
                        background: 'var(--surface-elevated)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid var(--border)',
                        marginBottom: '1.5rem'
                      }}>
                        <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)', marginBottom: '1rem', textTransform: 'uppercase', letterSpacing: '1px'}}>
                          Race Timer
                        </div>
                        <button className="btn btn-secondary" onClick={togglePause} style={{width: '100%', padding: '1rem', marginBottom: '0.75rem'}}>
                          {racePaused ? '‚ñ∂ Resume Race' : '‚è∏ Pause Race'}
                        </button>
                        <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', textAlign: 'center'}}>
                          {racePaused ? 'Race is currently paused' : 'Race timer is running'}
                        </div>
                      </div>

                      <div style={{
                        background: 'linear-gradient(135deg, rgba(255, 204, 0, 0.15) 0%, var(--surface-elevated) 100%)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '2px solid var(--race-yellow)',
                        marginBottom: '1.5rem'
                      }}>
                        <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)', marginBottom: '1rem', textTransform: 'uppercase', letterSpacing: '1px'}}>
                          Finish Race
                        </div>
                        <button className="btn btn-primary" onClick={finishRace} style={{width: '100%', padding: '1rem', background: 'var(--race-yellow)', color: 'var(--dark-bg)'}}>
                          üèÅ Chequered Flag
                        </button>
                        <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', textAlign: 'center', marginTop: '0.5rem'}}>
                          End race and show final results
                        </div>
                      </div>

                      <div style={{
                        background: 'var(--surface-elevated)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid var(--border)'
                      }}>
                        <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)', marginBottom: '1rem', textTransform: 'uppercase', letterSpacing: '1px'}}>
                          Danger Zone
                        </div>
                        <button className="btn btn-danger" onClick={resetRace} style={{width: '100%', padding: '1rem'}}>
                          üîÑ Reset Race
                        </button>
                        <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', textAlign: 'center', marginTop: '0.5rem'}}>
                          This will clear all race data and return to setup
                        </div>
                      </div>
                    </div>

                    {raceStarted && (
                      <div className="section">
                        <div className="section-title">Race Parameters</div>
                        
                        <div style={{
                          padding: '1rem',
                          background: 'var(--surface-elevated)',
                          borderRadius: '8px',
                          border: '1px solid var(--border)',
                          marginBottom: '1.5rem',
                          fontSize: '0.875rem',
                          color: 'var(--text-secondary)'
                        }}>
                          üí° Changes take effect immediately
                        </div>

                        <div className="form-group">
                          <label className="form-label">Race Duration (minutes)</label>
                          <input 
                            type="number" 
                            className="form-input" 
                            value={raceDuration}
                            onChange={(e) => setRaceDuration(Number(e.target.value))}
                            min="60"
                            max="1440"
                            step="5"
                          />
                          <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.5rem'}}>
                            {Math.floor(raceDuration / 60)}h {raceDuration % 60}m
                          </div>
                        </div>

                        <div className="form-group">
                          <label className="form-label">Kart Range (minutes)</label>
                          <input 
                            type="number" 
                            className="form-input" 
                            value={kartRange}
                            onChange={(e) => setKartRange(Number(e.target.value))}
                            min="20"
                            max="120"
                          />
                          <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.5rem'}}>
                            Time between pit stops
                          </div>
                        </div>

                        <div className="form-group">
                          <label className="form-label">Minimum Pit Stop Time (seconds)</label>
                          <input 
                            type="number" 
                            className="form-input" 
                            value={minPitTime}
                            onChange={(e) => {
                              const newMinPitTime = Number(e.target.value);
                              setMinPitTime(newMinPitTime);
                              // If min pit time is 0, also set pit exit time to 0
                              if (newMinPitTime === 0) {
                                setPitExitTime(0);
                              }
                            }}
                            min="0"
                            max="300"
                          />
                          <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.5rem'}}>
                            Mandatory time in pit bay (set to 0 if no minimum)
                          </div>
                        </div>

                        <div className="form-group">
                          <label className="form-label">Pit Exit Time (seconds)</label>
                          <input 
                            type="number" 
                            className="form-input" 
                            value={pitExitTime}
                            onChange={(e) => setPitExitTime(Number(e.target.value))}
                            min="0"
                            max="60"
                            disabled={minPitTime === 0}
                          />
                          <div style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.5rem'}}>
                            {minPitTime === 0 ? 'Disabled when no minimum pit time' : 'Time from pit bay to exit line'}
                          </div>
                        </div>

                        <div style={{
                          padding: '1rem',
                          background: 'var(--dark-bg)',
                          borderRadius: '8px',
                          border: '1px solid var(--border)',
                          fontSize: '0.875rem'
                        }}>
                          <div style={{color: 'var(--text-secondary)', marginBottom: '0.5rem'}}>
                            <strong>Read-Only:</strong>
                          </div>
                          {teamName && (
                            <div style={{marginBottom: '0.5rem'}}>
                              <span style={{color: 'var(--text-secondary)'}}>Team:</span> <span style={{color: 'white'}}>{teamName}</span>
                            </div>
                          )}
                          <div>
                            <span style={{color: 'var(--text-secondary)'}}>Track:</span> <span style={{color: 'white'}}>{trackName}</span>
                          </div>
                        </div>
                      </div>
                    )}
                  </>
                )}
              </>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>